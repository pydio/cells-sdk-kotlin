# Kotlin OpenAPI SDK for Cells

We use the swagger specification that is maintained in Cells main repo and Swagger to generate a standard Kotlin SDK.
The generated code can be found in this module, it should not be manually touched / modified.

We then also provide a _wrapper_ SDK to ease client application usage, see `sdk-kotlin` module.

## Regenerate the SDK

We use [swagger-codegen](https://swagger.io/docs/open-source-tools/swagger-codegen/) to generate the Kotlin base-code client.

For the time being, we rather clone the repository in a temp location to generate the new version of
the code and then replace the `com.pydio.kotlin.openapi` package in the local repository, to avoid
polluting the main repo with autogenerated files (gradle, doc, config files...)

### With OpenAPI 3

Note: you can check for new
release [here](https://github.com/OpenAPITools/openapi-generator/releases).

```sh
branch=main
mkdir -p /tmp/forSwagger
cd /tmp/forSwagger
git clone https://github.com/pydio/cells-sdk-kotlin.git
cd cells-sdk-kotlin
git checkout $branch
cd sdk-openapi

GENERATOR_VERSION=7.8.0
wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/${GENERATOR_VERSION}/openapi-generator-cli-${GENERATOR_VERSION}.jar -O openapi-generator-cli.jar
```

This is a manual tedious process:

- Retrieve Cells' JSON Swagger-V2 spec here:
  https://raw.githubusercontent.com/pydio/cells/main/common/proto/rest/cellsapi-rest.swagger.json
- Copy/paste specification file at: https://editor-next.swagger.io/
- Use Edit / convert to YAML
- Use Edit / convert to OpenAPI v3
- Paste back the resulting specifications in the sdk-openapi root folder in cellsapi-rest.swagger.yml

Then generate the SDK:

```sh
# WARNING: Update
SDK_DEFAULT_AGENT="PydioCells/v4.4.6 KotlinSDK/v0.1.1"

java -jar openapi-generator-cli.jar generate -g kotlin -i ./cellsapi-rest.swagger.yml -o /tmp/forSwagger/cells-sdk-kotlin/sdk-openapi --invoker-package com.pydio.kotlin.openapi  --api-package com.pydio.kotlin.openapi.api  --model-package com.pydio.kotlin.openapi.model --http-user-agent "${SDK_DEFAULT_AGENT}"

cd $GITPATH/github.com/pydio/cells-sdk-kotlin/sdk-openapi/src/main/kotlin/com/pydio/kotlin/
rm -rf ./openapi/{model,api}
mv /tmp/forSwagger/cells-sdk-kotlin/sdk-openapi/src/main/kotlin/com/pydio/kotlin/openapi/{model,api} ./openapi/

# Also copy used sagger file for later references
export CELLS_VERSION=4.4.6
cp /tmp/forSwagger/cells-sdk-kotlin/sdk-openapi/cellsapi-rest.swagger.yml $GITPATH/github.com/pydio/cells-sdk-kotlin/sdk-openapi/src/main/kotlin/com/pydio/kotlin/openapi/cellsapi-rest-${CELLS_VERSION}.swagger.yml

# For the record, more details about the possible options:
java -jar swagger-codegen-cli.jar help generate
```

## Tmp extra steps

In sept 2024, we must also:

- retrieve infrastructure package and rename it:

```sh
cd $GITPATH/github.com/pydio/cells-sdk-kotlin/sdk-openapi/src/main/kotlin/org
mv /tmp/forSwagger/cells-sdk-kotlin/sdk-openapi/src/main/kotlin/org/openapitools .
```

We must then refactor the openapitools/infrastructure package to be back in our layers:
a.k.a from `org/openapitools/infrastructure` to `com/pydio/kotlin/openapi/infrastructure`

To do so:

- remove com/pydio/kotlin/openapi/infrastructure
- delete compiled code under sdk-openapi/bin/main, or it blocks the refactoring
- launch the refactor via click in the IDE
